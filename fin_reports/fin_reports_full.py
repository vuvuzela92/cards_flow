import asyncio
import logging
from my_fin_rep_utils import fetch_all_data, load_api_tokens
from utils_sql import create_connection_to_vector_db, execute_query


# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s [%(levelname)s] %(message)s',
    handlers=[
        logging.FileHandler('fin_reports.log'),  # –õ–æ–≥–∏ –±—É–¥—É—Ç –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –≤ —Ñ–∞–π–ª fin_reports.log
        logging.StreamHandler()  # –õ–æ–≥–∏ —Ç–∞–∫–∂–µ –±—É–¥—É—Ç –≤—ã–≤–æ–¥–∏—Ç—å—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å
    ]
)

if __name__ == "__main__":
    asyncio.run(fetch_all_data(load_api_tokens(), num_weeks=1))
    logging.info("‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î
    connection = create_connection_to_vector_db()
    # –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
    query_penalties = """REFRESH MATERIALIZED VIEW CONCURRENTLY public.penalties_mv;"""
    execute_query(connection, query_penalties)
    logging.info("–ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ penalties_mv üîÅ")

    query_fin_rep = """REFRESH MATERIALIZED VIEW CONCURRENTLY public.fin_reports_mv;"""
    execute_query(connection, query_fin_rep)
    logging.info("–ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ fin_reports_mv üîÅ")

    query_fin_deductions = """REFRESH MATERIALIZED VIEW CONCURRENTLY public.fin_deductions_mv;"""
    execute_query(connection, query_fin_rep)
    logging.info("–ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ fin_deductions_mv üîÅ")

    query_fin_weekly_fin_rep = """REFRESH MATERIALIZED VIEW CONCURRENTLY public.weekly_fin_reports_mv;"""
    execute_query(connection, query_fin_rep)
    logging.info("–ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ weekly_fin_reports_mv üîÅ")
